# API

Redstone Computer Utilities 的 API 与事件文档。

## 稳定性

主版本号为零（0.x.x）的 API 和事件回调均不稳定，可能会在任何时候发生改变。主版本更新也可能带来破坏性改变。

## 连接与认证

连接使用 WebSocket，path 为 `/`，query 参数如下。

| 参数        | 类型   | 说明                                                                             |
| ----------- | ------ | -------------------------------------------------------------------------------- |
| name        | string | **必要**，唯一的外部程序标识符，**必须**为只由字母、数字和下划线组成的非空字符串 |
| description | string | 可选，外部程序的说明                                                             |
| key         | string | 可选，可配置的认证密钥                                                           |

相同 `name` 的连接至多存在一个，之前创建的拥有相同 `name` 的连接会被断开。一个连接只能被一个外部程序使用。服务器默认监听地址为 `localhost:37265`。

> 示例
> 
> `ws://localhost:37265/?name=script1`
> 
> `ws://localhost:37265/?name=script2&description=An%20example%20script&key=SECRET_VERIFICATION_KEY`

## 消息

消息使用 JSON 表示。

> 示例
> 
> ```json
> // 调用 API
> {
>     "api": "<API 名称>",
>     "content": {},  // 调用参数
>     "id": 1  // 每次 API 调用或发布事件时的唯一标识符
> }
> ```
> 
> ```json
> // API 调用成功
> {
>     "result": {},  // API 返回数据
>     "id": 1  // 对应的唯一标识符
> }
> ```
> 
> ```json
> // API 调用错误
> {
>     "result": -1,  // API 返回错误编号
>     "id": 1  // 对应的唯一标识符
> }
> ```
>
> ```json
> // 发布事件
> {
>     "event": "<事件名称>",
>     "param": {},  // 事件参数
>     "content": {},  // 事件内容
>     "id": 2  // 每次 API 调用或发布事件时的唯一标识符
> }
> ```
> 
> ```json
> // 事件处理成功
> {
>     "finish": {},  // 外部程序处理事件后返回数据
>     "id": 2  // 对应的唯一标识符
> }
> ```
> 
> ```json
> // 事件处理错误
> {
>     "finish": -1,  // 外部程序处理事件后返回错误编号
>     "id": 2  // 对应的唯一标识符
> }
> ```

API 和事件处理均为同步执行，服务器只在等待事件处理回应时接受 API 调用，且会在接受下一条消息前锁定游戏主线程。在其他时间调用的 API 会推迟到开始处理下一个事件后执行。等待消息时有可配置的时间限额，超出限额将会断开连接以防止死锁。

### API

- 事件
  - [`subscribe` 订阅事件](#subscribe)
  - [`unsubscribe` 取消订阅事件](#unsubscribe)
- 接口
  - [`newInterface` 创建接口](#newInterface)
  - [`removeInterface` 移除接口](#removeInterface)
  - [`listInterface` 列出所有接口](#listInterface)
  - [`readInterface` 读取接口数值](#readInterface)
  - [`writeInterface` 写入接口数值](#writeInterface)
- 世界
  <!--
  - [`queryBlock` 查询方块](#queryBlock)
  - [`setBlock` 设置方块及其属性](#setBlock)
  - [`queryEntity` 查询实体](#queryEntity)
  - [`setEntity` 设置实体属性](#setEntity)
  - [`summonEntity` 生成实体](#summonEntity)
  - [`removeEntity` 移除实体](#removeEntity) -->
  - [`queryGametime` 查询游戏时间](#queryGametime)
  - [`executeCommand` 执行命令](#executeCommand)
- 杂项
  - [`log` 发布日志消息](#log)

### 事件

- 外部程序生命周期
  - [`scriptInitialize` 当外部程序初始化](#scriptInitialize)
  - [`scriptRun` 当执行 `/rcu run`](#scriptRun)
- 接口
  - [`interfaceChange` 当接口数值改变](#interfaceChange)
- 世界
  - [`redstoneChange` 当接收的红石信号改变](#redstoneChange)
  - [`blockChange` 当方块改变](#blockChange)
  - [`blockUpdate` 当接收方块更新](#blockUpdate)
- 杂项
  - [`alarm` 当定时触发](#alarm)

### 错误

| 错误编号 | 错误名称        |
| -------- | --------------- |
| -1       | GeneralError    |
| -2       | ArgumentInvalid |
| -3       | NameIllegal     |
| -4       | NameExists      |
| -5       | NameNotFound    |
| -6       | InternalError   |
| -7       | ChunkUnloaded   |

### 类型

JSON 已有类型不再列出。注意：number 类型的数据可能没有范围限制。

| 类型名称  | 说明                                                           | 示例                                                                                               |
| --------- | -------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- |
| pos       | 由 xyz 坐标和世界标识符表示的方块位置                          | `[1, 2, 3, "minecraft:overworld"]`                                                                 |
| interface | 与创建接口时提供的参数类似的接口定义，选项若未提供则为空 array | `{"lsb": [1, 2, 3, "minecraft:overworld"], "msb": [4, 5, 6, "minecraft:overworld"], "option": []}` |

## API

### `subscribe`

订阅事件

| 调用参数 | 类型   | 说明               | 示例              |
| -------- | ------ | ------------------ | ----------------- |
| name     | string | **必要**，事件名   | `timer`           |
| param    | object | **必要**，事件参数 | `{"interval": 1}` |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误        | 说明         |
| --------------- | ------------ |
| GeneralError    | 已订阅该事件 |
| NameNotFound    | 事件名不存在 |
| ArgumentInvalid | 事件参数无效 |

### `unsubscribe`

取消订阅事件

| 参数  | 类型   | 说明                           | 示例              |
| ----- | ------ | ------------------------------ | ----------------- |
| name  | string | **必要**，事件名               | `timer`           |
| param | object | **必要**，订阅时提供的事件参数 | `{"interval": 1}` |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误        | 说明         |
| --------------- | ------------ |
| GeneralError    | 未订阅该事件 |
| NameNotFound    | 事件名不存在 |
| ArgumentInvalid | 事件参数无效 |

### `newInterface`

创建接口

| 参数   | 类型   | 说明                                                               | 示例                               |
| ------ | ------ | ------------------------------------------------------------------ | ---------------------------------- |
| name   | string | **必要**，接口名，**必须**为只由字母、数字和下划线组成的非空字符串 | `"interface1"`                     |
| lsb    | pos    | **必要**，接口最低位方块坐标                                       | `[1, 2, 3, "minecraft:overworld"]` |
| msb    | pos    | **必要**，接口最高位方块坐标                                       | `[4, 5, 6, "minecraft:overworld"]` |
| option | array  | 可选，每项为 string 类型的选项                                     | `["force", "skip=1"]`              |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误        | 说明         |
| --------------- | ------------ |
| GeneralError    | 接口不完整   |
| NameIllegal     | 接口名无效   |
| NameExists      | 接口名已存在 |
| ArgumentInvalid | 选项无效     |

### `removeInterface`

移除接口

| 参数 | 类型   | 说明             | 示例           |
| ---- | ------ | ---------------- | -------------- |
| name | string | **必要**，接口名 | `"interface1"` |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误     | 说明         |
| ------------ | ------------ |
| NameNotFound | 接口名不存在 |

### `listInterface`

列出所有接口

| 参数 | 类型 | 说明 | 示例 |
| ---- | ---- | ---- | ---- |
| 无   |      |      |      |

| 返回数据  | 类型   | 说明                                                        | 示例                                                                                                               |
| --------- | ------ | ----------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| interface | object | 每项为 string 类型的名称和 interface 类型的接口定义的键值对 | `{"interface1": {"lsb": [1, 2, 3, "minecraft:overworld"], "msb": [4, 5, 6, "minecraft:overworld"], "option": []}}` |

| 返回错误 | 说明 |
| -------- | ---- |
| 无       |      |

### `readInterface`

读取接口数值

| 参数 | 类型   | 说明             | 示例           |
| ---- | ------ | ---------------- | -------------- |
| name | string | **必要**，接口名 | `"interface1"` |

| 返回数据 | 类型   | 说明                             | 示例 |
| -------- | ------ | -------------------------------- | ---- |
| value    | number | 接口目前接收的红石信号构成的数值 | `42` |

| 返回错误      | 说明         |
| ------------- | ------------ |
| NameNotFound  | 接口名不存在 |
| GeneralError  | 接口不完整   |
| ChunkUnloaded | 区块已卸载   |

### `writeInterface`

写入接口数值

| 参数  | 类型   | 说明                                   | 示例           |
| ----- | ------ | -------------------------------------- | -------------- |
| name  | string | **必要**，接口名                       | `"interface1"` |
| value | number | **必要**，接口输出的红石信号构成的数值 | `42`           |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误     | 说明         |
| ------------ | ------------ |
| NameNotFound | 接口名不存在 |
| GeneralError | 接口不完整   |
| ChunkUnloaded | 区块已卸载   |

<!-- ### `queryBlock`

### `setBlock`

### `queryEntity`

### `setEntity`

### `summonEntity`

### `removeEntity` -->

### `queryGametime`

查询游戏时间

| 参数 | 类型 | 说明 | 示例 |
| ---- | ---- | ---- | ---- |
| 无   |      |      |      |

| 返回数据 | 类型   | 说明         | 示例    |
| -------- | ------ | ------------ | ------- |
| gametime | number | 当前游戏时间 | `10042` |

| 返回错误 | 说明 |
| -------- | ---- |
| 无       |      |

### `executeCommand`

执行命令

| 参数    | 类型   | 说明                   | 示例                            |
| ------- | ------ | ---------------------- | ------------------------------- |
| command | string | **必要**，前缀斜杠可选 | `/setblock 1 2 3 minecraft:air` |

| 返回数据 | 类型   | 说明                 | 示例                             |
| -------- | ------ | -------------------- | -------------------------------- |
| feedback | string | 命令执行时输出的消息 | `"Changed the block at 1, 2, 3"` |
| error    | string | 命令执行时输出的错误 | `"No entity was found"`          |
| result   | number | 命令执行结果         | `0`                              |

| 返回错误 | 说明 |
| -------- | ---- |
| 无       |      |

### `log`

发布日志消息，除在服务器控制台输出并在输出内容中标明级别外，额外的行为如下

| 级别  | 额外行为                                                 |
| ----- | -------------------------------------------------------- |
| debug | 无                                                       |
| info  | 向权限等级 >= 2 的玩家广播                               |
| warn  | 使用黄色字体向权限等级 >= 2 的玩家广播                   |
| error | 使用红色字体向权限等级 >= 2 的玩家广播                   |
| fatal | 使用红色字体向权限等级 >= 2 的玩家广播并断开外部程序连接 |

| 参数    | 类型   | 说明                                                                                | 示例                           |
| ------- | ------ | ----------------------------------------------------------------------------------- | ------------------------------ |
| message | string | **必要**，内容                                                                      | `"An unknown error occurred."` |
| level   | string | **必要**，级别，**必须**为 `"debug"` `"info"` `"warn"` `"error"` `"fatal"` 中的一个 | `"info"`                       |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误        | 说明     |
| --------------- | -------- |
| ArgumentInvalid | 级别无效 |

## 事件

### `scriptInitialize`

当外部程序初始化，在连接建立后的下一个游戏刻开始时调用

| 事件参数 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 事件内容 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误      | 说明                                               |
| ------------- | -------------------------------------------------- |
| InternalError | 外部程序内部错误，对于该事件若返回该错误则断开连接 |

### `scriptRun`

当执行 `/rcu run`

| 事件参数 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 事件内容 | 类型  | 说明                                        | 示例                                                                                                                             |
| -------- | ----- | ------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| argument | array | 每项为 string 类型和 interface 类型中的一个 | `["set", {"interface1": {"lsb": [1, 2, 3, "minecraft:overworld"], "msb": [4, 5, 6, "minecraft:overworld"], "option": []}}, "1"]` |

| 返回数据 | 类型   | 说明         | 示例 |
| -------- | ------ | ------------ | ---- |
| result   | number | 命令执行结果 | `0`  |

| 返回错误        | 说明             |
| --------------- | ---------------- |
| InternalError   | 外部程序内部错误 |
| ArgumentInvalid | 参数无效         |

### `interfaceChange`

当接口数值改变，该接口**必须**先接收方块更新才能检测并判断数值

| 事件参数 | 类型   | 说明             | 示例           |
| -------- | ------ | ---------------- | -------------- |
| name     | string | **必要**，接口名 | `"interface1"` |

| 事件内容 | 类型   | 说明                             | 示例 |
| -------- | ------ | -------------------------------- | ---- |
| previous | number | 接口之前接收的红石信号构成的数值 | `42` |
| current  | number | 接口目前接收的红石信号构成的数值 | `41` |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误      | 说明             |
| ------------- | ---------------- |
| InternalError | 外部程序内部错误 |

### `redstoneChange`

当接收的红石信号改变，该方块**必须**先接收方块更新才能检测并判断信号

| 事件参数 | 类型 | 说明                             | 示例                               |
| -------- | ---- | -------------------------------- | ---------------------------------- |
| pos      | pos  | **必要**，接收红石信号的方块坐标 | `[1, 2, 3, "minecraft:overworld"]` |

| 事件内容 | 类型   | 说明                     | 示例 |
| -------- | ------ | ------------------------ | ---- |
| previous | number | 方块之前接收的红石信号值 | `2`  |
| current  | number | 方块目前接收的红石信号值 | `16` |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误      | 说明             |
| ------------- | ---------------- |
| InternalError | 外部程序内部错误 |

### `blockChange`

当方块改变

| 事件参数 | 类型 | 说明               | 示例                               |
| -------- | ---- | ------------------ | ---------------------------------- |
| pos      | pos  | **必要**，方块坐标 | `[1, 2, 3, "minecraft:overworld"]` |

| 事件内容 | 类型   | 说明             | 示例              |
| -------- | ------ | ---------------- | ----------------- |
| previous | string | 之前的方块标识符 | `minecraft:stone` |
| current  | string | 目前的方块标识符 | `minecraft:air`   |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误      | 说明             |
| ------------- | ---------------- |
| InternalError | 外部程序内部错误 |

### `blockUpdate`

当接收方块更新

| 事件参数 | 类型   | 说明                                                                                     | 示例                               |
| -------- | ------ | ---------------------------------------------------------------------------------------- | ---------------------------------- |
| pos      | pos    | **必要**，接收方块更新的方块坐标                                                         | `[1, 2, 3, "minecraft:overworld"]` |
| type     | string | **必要**，方块更新类型，**必须**为 `"neighborUpdate"` `"postPlacement"` `"any"` 中的一个 | `"neighborUpdate"`                 |

| 事件内容 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误      | 说明             |
| ------------- | ---------------- |
| InternalError | 外部程序内部错误 |

### `alarm`

当定时触发，可以在当前游戏刻的后续微时序位置触发

| 事件参数 | 类型   | 说明                                                              | 示例      |
| -------- | ------ | ----------------------------------------------------------------- | --------- |
| gametime | number | **必要**，目标游戏时间                                            | `10042`   |
| at       | string | **必要**，触发的微时序位置，**必须**为 `"start"` `"end"` 中的一个 | `"start"` |

| 事件内容 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回数据 | 类型 | 说明 | 示例 |
| -------- | ---- | ---- | ---- |
| 无       |      |      |      |

| 返回错误      | 说明             |
| ------------- | ---------------- |
| InternalError | 外部程序内部错误 |
